<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Historial (Imprimible por Hilos)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --text: #0b1224;
      --line: #e2e8f0;
      --soft: #f8fafc;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      color: var(--text)
    }

    .wrap {
      max-width: 1100px;
      margin: 24px auto;
      padding: 16px
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: end;
      margin: 0 0 16px;
      position: sticky;
      top: 0;
      background: #fff;
      padding: 8px 0 12px;
      border-bottom: 1px solid var(--line)
    }

    .toolbar .block {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px
    }

    label {
      font-size: 12px;
      color: #475569
    }

    input,
    select,
    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 14px
    }

    button {
      cursor: pointer;
      font-weight: 600
    }

    .btn-accent {
      background: #0ea5e9;
      color: #002232;
      border-color: #0284c7
    }

    h2 {
      margin: 18px 0 6px
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px
    }

    th,
    td {
      border: 1px solid var(--line);
      padding: 8px;
      font-size: 13px;
      vertical-align: top
    }

    th {
      background: var(--soft);
      text-align: left
    }

    .small {
      font-size: 12px;
      color: #64748b
    }

    .sep {
      margin: 6px 0 14px
    }

    @media print {
      .toolbar {
        display: none
      }

      .wrap {
        margin: 0 auto;
        padding: 0
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="block">
        <label for="q">Buscar texto</label>
        <input id="q" type="text" placeholder="Título, categoría, notas...">
      </div>
      <div class="block" style="margin-left:auto">
        <label>&nbsp;</label>
        <button id="btnPrint" class="btn-accent">Imprimir / Guardar PDF</button>
      </div>
    </div>

    <div id="content"></div>
    <div class="small sep" id="countInfo"></div>
  </div>

  <script>
    const API = (p) => '/api' + p;
    const $ = (s) => document.querySelector(s);

    function fmtDate(iso) { return new Date(iso).toLocaleString(); }

    function groupByCaseId(items) {
      const map = new Map();
      for (const h of items) {
        if (!map.has(h.caseId)) map.set(h.caseId, []);
        map.get(h.caseId).push(h);
      }
      for (const [k, arr] of map) {
        arr.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      }
      return map;
    }

    function titleFromEvents(events) {
      // toma el último snapshot con título/categoría
      for (let i = events.length - 1; i >= 0; i--) {
        const snap = events[i].after ?? events[i].before;
        if (snap && (snap.titulo || snap.categoria)) return { t: snap.titulo || '', c: snap.categoria || '' };
      }
      return { t: '', c: '' };
    }

    async function load() {
      const q = $('#q').value.trim().toLowerCase();
      const res = await fetch(API('/history'));
      let data = await res.json();

      if (q) {
        const has = (obj) => JSON.stringify(obj || {}).toLowerCase().includes(q);
        data = data.filter(h => (h.caseId || '').toLowerCase().includes(q) || has(h.after) || has(h.before));
      }

      const map = groupByCaseId(data);
      const content = $('#content');
      content.innerHTML = '';

      let total = 0;
      for (const [caseId, events] of map) {
        total += events.length;
        const { t, c } = titleFromEvents(events);
        const section = document.createElement('section');
        section.innerHTML = `
          <h2>Hilo — Case ID: ${caseId}</h2>
          <div class="small">${t || ''} ${c ? ' · ' + c : ''}</div>
          <table>
            <thead>
              <tr><th>Fecha</th><th>Acción</th><th>Título</th><th>Categoría</th><th>Estado</th><th>Notas</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        `;
        const tbody = section.querySelector('tbody');
        for (const e of events) {
          const snap = e.after ?? e.before ?? {};
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(e.timestamp)}</td>
            <td>${e.action}</td>
            <td>${snap.titulo || ''}</td>
            <td>${snap.categoria || ''}</td>
            <td>${snap.estado || ''}</td>
            <td>${snap.notas || ''}</td>
          `;
          tbody.appendChild(tr);
        }
        content.appendChild(section);
      }
      document.getElementById('countInfo').textContent = `${total} registro(s) en ${map.size} hilo(s)`;
    }

    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('q').addEventListener('input', load);
    load();
  </script>
</body>

</html>